(window.webpackJsonp=window.webpackJsonp||[]).push([[82],{"Pi/L":function(t,e,s){"use strict";s.r(e),s.d(e,"INV_Ageing",(function(){return c}));var i=s("Do2H"),o=s("Lp6j"),l=s("vTM8"),h=s("eQJW"),a=s("1xwR"),n=s("mvPR"),r=s("dH+5"),d=s("Zgxw"),u=s("MCLT"),D=s("8iaB");class c extends a.b{constructor(t){super(t),this.k=0,this.drMain=null,this.colSlabIndex=-1,this.colSpanBF=-1,this.colSubTotalStartIndex=0,this.colQOHIndex=-1,this.colMonthIndex=-1,this.CntMonths=0,this.Slabs=new Array,this.iSlabs=new Array,this.dblQty=0,this.dblValue=0,this.dblAvgRate=0,this.ShowLevelTree=!1,this.IsConsolidated=!1,this.BatchConsolidated=!1,this.ShowYearWise=!1,this.ShowMonthWise=!1,this.LevelNo=0,this.DefValuation=0,this.ForeignCurrencyID=0,this.CurrencyType=0,this.strProductID=null,this.AgeingDimWhere="",this.SortTransactionsBy="",this.SlabQty=null,this.SlabValue=null,this.SlabPercent=null,this.MonthFromDate=null,this.FilterData="",this.HideBinQty=!1,this.IsBinDetail=!1,this.iLoop=0,this.lstPCRates=new Array,this.TagID=0,this.IsPCodeLink=!1,this.IsPNameLink=!1,this.ShowDetailReport=!1,this.TempRTVisible=!1,this.strExcludeStockTransfer="",this.lstTotal=null,this.lstParents=new Array,this.dbl=0,this.dblS0=0,this.dblS1=0,this.dblS2=0,this.dblS3=0,this.dblS4=0,this.dblIssue=0,this.dtProducts=null}LoadReport(){if(this.GrdRow=-1,this.colSubTotalStartIndex=-1,this.AggTotal=o.e.NumArray(this.oColumns.length,2),this.lstTotal=new Array,this.ViewModel.Preferences.ContainsKey("Slabs")){let t=new o.f;t.LoadXml("<XML>"+this.ViewModel.Preferences.Slabs+"</XML>"),this.Slabs.Clear(),this.iSlabs.Clear(),t.DocumentElement.childNodes.forEach(t=>{this.iSlabs.push(parseInt(t.innerHTML)),this.Slabs.push(this.ViewModel.oReportDialog.ToDate.Date.AddDays(this.iSlabs[this.iSlabs.length-1]))})}for(let s=0;s<this.ViewModel.ColumnSource.length;s++)if("FLOAT"==this.ViewModel.ColumnSource[s].ColumnType){this.colSpanBF=s;break}if(this.ViewModel.lstGroup.length>0)for(this.k=0;this.k<this.ViewModel.ColumnSource.length;this.k++)if(this.ViewModel.lstGroup[0].TotalCols.ContainsKey(this.ViewModel.ColumnSource[this.k].ID)){this.colSubTotalStartIndex=this.k;break}for(let s=this.ViewModel.ColumnSource.length-1;s>=0;s--)"Expired"==this.ViewModel.ColumnSource[s].ID||"Balance"==this.ViewModel.ColumnSource[s].ID?this.colSlabIndex=s:"QOH"==this.ViewModel.ColumnSource[s].ID&&(this.colQOHIndex=s);this.FilterData=this.ViewModel.Preferences.ContainsKey("Filter")?this.ViewModel.Preferences.Filter:"";let t=new Array;for(let s=0;s<this.ViewModel.ColumnSource.length;s++)t.push(this.ViewModel.ColumnSource[s]);if(82==this.ViewModel.StaticReportType){if(this.ViewModel.Preferences.ContainsKey("MonthWiseMonths")){let t=new o.f;t.LoadXml("<XML>"+this.ViewModel.Preferences.MonthWiseMonths+"</XML>");let e=o.f.SelectSingleNode(t.DocumentElement,"IsChecked");if(null!=e&&"1"==e.innerHTML&&(this.ShowMonthWise=!0,e=o.f.SelectSingleNode(t.DocumentElement,"Text"),this.CntMonths=o.e.Int(e.innerHTML),this.CntMonths<=0&&(this.ShowMonthWise=!1),this.ShowMonthWise)){this.iSlabs.Clear(),this.Slabs.Clear();let t=this.ViewModel.oReportDialog.ToDate.Date;for(let e=0;e<this.CntMonths;e++)this.iSlabs.push(1),t=new Date(t.getFullYear(),t.getMonth(),1).AddMonths(1).AddDays(-1),this.Slabs.push(t),t=t.AddDays(1)}}}else if(83==this.ViewModel.StaticReportType)this.SlabPercent=t.find(t=>"SlabPercent"==t.ID),this.SlabPercent&&t.Remove(this.SlabPercent);else if(84==this.ViewModel.StaticReportType){if(this.ViewModel.Preferences.ContainsKey("ShowYearWise")){let t=new o.f;t.LoadXml("<XML>"+this.ViewModel.Preferences.ShowYearWise+"</XML>");let e=o.f.SelectSingleNode(t.DocumentElement,"IsChecked");if(null!=e&&"1"==e.innerHTML&&(this.ShowYearWise=!0,e=o.f.SelectSingleNode(t.DocumentElement,"Text"),this.CntMonths=o.e.Int(e.innerHTML),this.CntMonths<=0&&(this.ShowYearWise=!1),this.ShowYearWise)){this.iSlabs.Clear(),this.Slabs.Clear();let t=new Date((new Date).getFullYear(),i.a.SessionManager.AccountingFromMonth-1,1);t>Date.Today()&&(t=t.AddYears(-1));for(let e=0;e<this.CntMonths;e++)this.iSlabs.push(1),this.Slabs.push(t),t=t.AddYears(-1)}}for(let e=t.length-1;e>=0;e--)"SlabQty"==t[e].ID?(this.SlabQty=t[e],t.RemoveAt(e),this.ViewModel.GrpReportTotal.TotalCols.ContainsKey("SlabQty")&&this.ViewModel.GrpReportTotal.TotalCols.Remove("SlabQty"),this.ViewModel.lstGroup.length>0&&this.ViewModel.lstGroup[0].TotalCols.ContainsKey("SlabQty")&&this.ViewModel.lstGroup[0].TotalCols.Remove("SlabQty")):"SlabValue"==t[e].ID&&(this.SlabValue=t[e],t.RemoveAt(e),this.ViewModel.GrpReportTotal.TotalCols.ContainsKey("SlabValue")&&this.ViewModel.GrpReportTotal.TotalCols.Remove("SlabValue"),this.ViewModel.lstGroup.length>0&&this.ViewModel.lstGroup[0].TotalCols.ContainsKey("SlabValue")&&this.ViewModel.lstGroup[0].TotalCols.Remove("SlabValue"))}if(null==this.SlabQty&&null==this.SlabValue){for(let t=this.ViewModel.ColumnSource.length-1;t>=0;t--){if("BalQty"==this.ViewModel.ColumnSource[t].ID){this.SlabQty=this.ViewModel.ColumnSource[t];break}if(83==this.ViewModel.StaticReportType&&"Quantity"==this.ViewModel.ColumnSource[t].ID){this.SlabQty=this.ViewModel.ColumnSource[t];break}if("Months"==this.ViewModel.ColumnSource[t].ID){this.colMonthIndex=t;break}}null==this.SlabQty&&(this.SlabQty=this.ViewModel.ColumnSource[this.ViewModel.ColumnSource.length-1])}if(82==this.ViewModel.StaticReportType)for(let s=0;s<30&&this.ViewModel.GrpReportTotal.TotalCols.ContainsKey("S"+s);s++)this.ViewModel.GrpReportTotal.TotalCols.Remove("S"+s),this.ViewModel.lstGroup.forEach(t=>{t.TotalCols.ContainsKey("S"+s)&&t.TotalCols.Remove("S"+s)});if(this.Slabs.length>0)for(let s=0,i=this.Slabs.length;s<=this.Slabs.length;s++,i--)if(84==this.ViewModel.StaticReportType){let e,o;null!=this.SlabQty&&(o=this.SlabQty.Clone(),this.ShowYearWise?(o.ID="S"+i,o.HeaderText=i==this.Slabs.length?"< "+this.Slabs[i-1].ToString("MMM yyyy"):1==this.Slabs[i].iMonth()?this.Slabs[i].ToString("yyyy"):this.Slabs[i].ToString("yyyy")+"-"+this.Slabs[i].AddYears(1).ToString("yy")):(o.ID="S"+s,o.HeaderText=0==s?"1-"+this.iSlabs[s]:s==this.Slabs.length?">"+this.iSlabs[this.iSlabs.length-1]:this.iSlabs[s-1]+1+"-"+this.iSlabs[s]),this.ShowYearWise||(s<this.iSlabs.length&&0==this.iSlabs[s]||s==this.iSlabs.length&&0==this.iSlabs[this.iSlabs.length-1])&&(o.HeaderAppearance.IsVisible=!1),t.push(o),this.ViewModel.IsTotalColsAdded||(this.ViewModel.lstGroup.forEach(e=>{e.TotalCols.push(o.ID,t.length-1)}),this.ViewModel.GrpReportTotal.TotalCols.push(o.ID,t.length-1))),null!=this.SlabValue&&(e=this.SlabValue.Clone(),null==this.SlabQty?this.ShowYearWise?(e.ID="SV"+i,e.HeaderText=i==this.Slabs.length?"< "+this.Slabs[i-1].ToString("MMM yyyy"):1==this.Slabs[i].iMonth()?this.Slabs[i].ToString("yyyy"):this.Slabs[i].ToString("yyyy")+"-"+this.Slabs[i].AddYears(1).ToString("yy")):(e.ID="SV"+s,e.HeaderText=0==s?"1-"+this.iSlabs[s]+" Value":s==this.Slabs.length?">"+this.iSlabs[this.iSlabs.length-1]+" Value":this.iSlabs[s-1]+1+"-"+this.iSlabs[s]+" Value"):(e.ID=this.ShowYearWise?"SV"+i:"SV"+s,e.HeaderText="Value"),this.ShowYearWise||(s<this.iSlabs.length&&0==this.iSlabs[s]||s==this.iSlabs.length&&0==this.iSlabs[this.iSlabs.length-1])&&(e.HeaderAppearance.IsVisible=!1),t.push(e),this.ViewModel.IsTotalColsAdded||(this.ViewModel.lstGroup.forEach(s=>{s.TotalCols.push(e.ID,t.length-1)}),this.ViewModel.GrpReportTotal.TotalCols.push(e.ID,t.length-1)))}else if(82==this.ViewModel.StaticReportType){let e=this.ViewModel.ColumnSource.find(t=>"Quantity"==t.ID);e||(e=this.ViewModel.ColumnSource.find(t=>"Expired"==t.ID)),e||(e=this.ViewModel.ColumnSource[this.ViewModel.ColumnSource.length-1]),e=e.Clone(),e.DataAppearance.IsVisible=!0,e.ID="S"+s,e.HeaderText=this.ShowMonthWise?s==this.Slabs.length?">"+this.Slabs[s-1].ToString("MMM yyyy"):this.Slabs[s].ToString("MMM yyyy"):0==s?"1-"+this.iSlabs[s]:s==this.Slabs.length?">"+this.iSlabs[this.iSlabs.length-1]:this.iSlabs[s-1]+1+"-"+this.iSlabs[s],("Expired"==this.FilterData||s<this.iSlabs.length&&0==this.iSlabs[s]||s==this.iSlabs.length&&(0==this.iSlabs[this.iSlabs.length-1]||"SelectedSlabActive"==this.FilterData))&&(e.HeaderAppearance.IsVisible=!1),t.Insert(this.colSlabIndex+s+1,e),this.ViewModel.GrpReportTotal.TotalCols.push(e.ID,this.colSlabIndex+s+1),this.ViewModel.GrpReportTotal.TotalCols.Slab=t.length-1,this.ViewModel.lstGroup.forEach(i=>{i.TotalCols.push(e.ID,this.colSlabIndex+s+1),i.TotalCols.Slab=t.length-1})}else{let e=null!=this.SlabQty?this.SlabQty.Clone():this.ViewModel.ColumnSource[this.ViewModel.ColumnSource.length-1].Clone();e.ID="S"+s,e.HeaderText=0==s?"1-"+this.iSlabs[s]:s==this.Slabs.length?">"+this.iSlabs[this.iSlabs.length-1]:this.iSlabs[s-1]+1+"-"+this.iSlabs[s],(s<this.iSlabs.length&&0==this.iSlabs[s]||s==this.iSlabs.length&&0==this.iSlabs[this.iSlabs.length-1])&&(e.HeaderAppearance.IsVisible=!1);let i=this.colSlabIndex+s+1;if(null!=this.SlabPercent&&(i=this.colSlabIndex+2*s+1),t.Insert(i,e),this.ViewModel.IsTotalColsAdded||(this.ViewModel.GrpReportTotal.TotalCols.push(e.ID,i),this.ViewModel.GrpReportTotal.TotalCols.Slab=t.length-1,this.ViewModel.lstGroup.forEach(s=>{s.TotalCols.push(e.ID,i),s.TotalCols.Slab=t.length-1})),null!=this.SlabPercent){let o=this.SlabPercent.Clone();o.ID="P"+s,o.HeaderText="%",o.HeaderAppearance.IsVisible=e.HeaderAppearance.IsVisible,i++,t.Insert(i,o)}}if(82==this.ViewModel.StaticReportType&&this.ViewModel.GrpReportTotal.TotalCols.ContainsKey("Slab")&&(this.ViewModel.GrpReportTotal.TotalCols.Remove("Slab"),this.ViewModel.lstGroup.forEach(t=>{t.TotalCols.Remove("Slab")})),(114==this.ViewModel.StaticReportType||115==this.ViewModel.StaticReportType)&&(this.CntMonths=0,-1!=this.colMonthIndex)){this.ViewModel.TotalCols.Clear(),this.ViewModel.GrpReportTotal.TotalCols.Clear(),114!=this.ViewModel.StaticReportType&&115!=this.ViewModel.StaticReportType||(this.ViewModel.AddTotalColumnsToGroup(this.ViewModel.GrpReportTotal,this.ViewModel.ReportDoc.SelectSingleNode("PactRevenURpts/PactRevenURptDef/ReportTotal/Columns")),this.ViewModel.TotalCols.Contains("Months")&&this.ViewModel.TotalCols.Remove("Months"),this.ViewModel.GrpReportTotal.TotalCols.ContainsKey("Months")&&this.ViewModel.GrpReportTotal.TotalCols.Remove("Months"),this.ViewModel.lstGroup.forEach(t=>{t.TotalCols.Clear(),this.ViewModel.AddTotalColumnsToGroup(t,this.ViewModel.ReportDoc.SelectSingleNode("PactRevenURpts/PactRevenURptDef/ReportTotal/Columns")),t.TotalCols.ContainsKey("Months")&&t.TotalCols.Remove("Months")}));let e=new Date(this.ViewModel.FromDatePicker.Date.getFullYear(),this.ViewModel.FromDatePicker.Date.getMonth(),1);if(this.MonthFromDate=e,114==this.ViewModel.StaticReportType){let t=0;if(this.ViewModel.Preferences.ContainsKey("ShowMonths")&&(t=o.e.Int(this.ViewModel.Preferences.ShowMonths),t>0&&(e=new Date(this.ViewModel.ToDatePicker.Date.getFullYear(),this.ViewModel.ToDatePicker.Date.getMonth(),1),e=e.AddMonths(1-t),e=new Date(e.getFullYear(),e.getMonth(),1),this.MonthFromDate=e)),0==t&&this.ViewModel.DontApplyDateFilter&&this.ViewModel.Preferences.ContainsKey("SalesDocs")&&this.ViewModel.Preferences.SalesDocs.length>0){let t="SELECT convert(datetime,min(DocDate)) FromDate FROM INV_DocDetails A WITH(NOLOCK) \n        WHERE A.CostCenterID IN("+this.ViewModel.Preferences.SalesDocs+") AND DocDate<=CONVERT(INT,CONVERT(DATETIME,'"+this.ViewModel.ToDatePicker.Date.ToString("dd MMM yyyy")+"')) AND A.StatusID<>438",s=i.a.report.ReportDataTable("RPT022",this.ViewModel.IsReportDB,t);null!=s&&s.length>0&&s.Columns.Contains("FromDate")&&(this.MonthFromDate=new Date(s.Rows[0].FromDate),this.MonthFromDate=new Date(this.MonthFromDate.getFullYear(),this.MonthFromDate.getMonth(),1),this.ViewModel.ToDatePicker.Date.getFullYear()-this.MonthFromDate.getFullYear()>15?this.MonthFromDate=e:e=this.MonthFromDate)}}else 115==this.ViewModel.StaticReportType&&(this.ViewModel.ColumnSource[this.colMonthIndex].HeaderAppearance.IsVisible=!1);let s=this.ViewModel.ToDatePicker.Date;if("DESC"==this.ViewModel.ColumnSource[this.colMonthIndex].DataFormat.Sort)for(;e<=s;){let s=this.ViewModel.ColumnSource[this.colMonthIndex].Clone();s.HeaderAppearance.IsVisible=!0,s.ID="M"+this.CntMonths,s.HeaderText=e.ToString("MMM yyyy"),t.Insert(this.colMonthIndex+1,s),e=e.AddMonths(1),this.ViewModel.TotalCols.push(s.ID),this.ViewModel.GrpReportTotal.TotalCols.push(s.ID,this.colMonthIndex+this.CntMonths),this.ViewModel.lstGroup.forEach(t=>{t.TotalCols.push(s.ID,this.colMonthIndex+this.CntMonths)}),this.CntMonths++}else for(;e<=s;){let s=this.ViewModel.ColumnSource[this.colMonthIndex].Clone();s.HeaderAppearance.IsVisible=!0,s.ID="M"+this.CntMonths,s.HeaderText=e.ToString("MMM yyyy"),t.Insert(this.colMonthIndex+this.CntMonths+1,s),e=e.AddMonths(1),this.ViewModel.TotalCols.push(s.ID),this.ViewModel.GrpReportTotal.TotalCols.push(s.ID,this.colMonthIndex+this.CntMonths),this.ViewModel.lstGroup.forEach(t=>{t.TotalCols.push(s.ID,this.colMonthIndex+this.CntMonths)}),this.CntMonths++}if(this.ViewModel.Preferences.ContainsKey("ShowMonths")){let e;if(e=o.e.Int(this.ViewModel.Preferences.ShowMonths),e>0){let e=this.ViewModel.ColumnSource[this.colMonthIndex].Clone();e.HeaderAppearance.IsVisible=!0,e.ID="Months",t.Insert(this.colMonthIndex+this.CntMonths+1,e),this.ViewModel.TotalCols.push(e.ID),this.ViewModel.GrpReportTotal.TotalCols.push(e.ID,this.colMonthIndex+this.CntMonths),this.ViewModel.lstGroup.forEach(t=>{t.TotalCols.push(e.ID,this.colMonthIndex+this.CntMonths)}),t.RemoveAt(this.colMonthIndex)}}}this.AggTotal=o.e.NumArray(t.length,2),this.ViewModel.ReportColumns=t,this.oColumns=this.ViewModel.ReportColumns,this.ViewModel.IsTotalColsAdded=!0,this.ViewModel.totals=o.e.NumArray(this.oColumns.length,this.ViewModel.lstGroup.length+1);try{if(this.LevelNo=0,this.ShowLevelTree=!1,this.ViewModel.Preferences.ContainsKey("ShowLevel")){let t=new o.f;t.LoadXml("<XML>"+this.ViewModel.Preferences.ShowLevel+"</XML>");let e=o.f.SelectSingleNode(t.DocumentElement,"IsChecked");null!=e&&"1"==e.innerHTML&&(this.ShowLevelTree=!0,e=o.f.SelectSingleNode(t.DocumentElement,"Text"),this.LevelNo=parseInt(e.innerHTML))}let t="";if(this.ChunkSize=this.ViewModel.Preferences.ContainsKey("ChunkSize")?parseInt(this.ViewModel.Preferences.ChunkSize):1,this.DefValuation=0,this.ViewModel.Preferences.ContainsKey("ValuationMethod")&&(this.DefValuation=o.e.Int(this.ViewModel.Preferences.ValuationMethod)),this.UnPostedDocsInclude=!(!this.ViewModel.Preferences.ContainsKey("IncludeUnPostedDocs")||"1"!=this.ViewModel.Preferences.IncludeUnPostedDocs),this.IsConsolidated=!(!this.ViewModel.Preferences.ContainsKey("ConsolidatedBatches")||"1"!=this.ViewModel.Preferences.ConsolidatedBatches),this.IsBinDetail=!(!this.ViewModel.Preferences.ContainsKey("BinDetail")||"1"!=this.ViewModel.Preferences.BinDetail),this.SortTransactionsBy=this.ViewModel.Preferences.ContainsKey("SortTransactionsBy")?this.ViewModel.Preferences.SortTransactionsBy:"",this.BatchConsolidated=!1,82==this.ViewModel.StaticReportType||83==this.ViewModel.StaticReportType){let t=i.a.report.DataSet("RPT022","SELECT [Value] FROM COM_CostCenterPreferences WITH(NOLOCK) WHERE CostCenterID=16 AND Name='ConsolidatedBatches'");null!=t&&t.Tables[0].length>0&&"TRUE"==t.Tables[0][0].Value.toString().toUpperCase()&&(this.BatchConsolidated=!0)}if(this.CurrencyType=0,this.ForeignCurrencyID=0,this.ViewModel.Preferences.ContainsKey("ForeignCurrency")){let t=new o.f;t.LoadXml("<XML>"+this.ViewModel.Preferences.ForeignCurrency+"</XML>");let e=o.f.SelectSingleNode(t.DocumentElement,"IsChecked");null!=e&&"1"==e.innerHTML&&(this.ForeignCurrencyID=parseInt(o.f.SelectSingleNode(t.DocumentElement,"Value").innerHTML))}else if(this.ViewModel.Preferences.ContainsKey("Currency")){let t=new o.f;t.LoadXml("<XML>"+this.ViewModel.Preferences.Currency+"</XML>"),this.CurrencyType=parseInt(o.f.SelectSingleNode(t.DocumentElement,"Type").innerHTML),1==this.CurrencyType?(o.e.IsEmpty(i.a.SessionManager.Preferences.DimensionwiseCurrency)||0==parseInt(i.a.SessionManager.Preferences.DimensionwiseCurrency))&&(this.CurrencyType=0):2==this.CurrencyType&&(this.ForeignCurrencyID=parseInt(o.f.SelectSingleNode(t.DocumentElement,"Value").innerHTML))}t=this.GetQuery(),i.a.report.ReportDataSetAsync("RPT022",this.ViewModel.IsReportDB,t).then(t=>{this.dsMain=t,this.dv=this.dvTable=this.dsMain.Tables[0];var e=this.ViewModel.BaseReportColumns.find(t=>181==t.CDGDO.FieldValue);e&&"2"==e.FormulaEvaluateAtEnd.SelectedValue&&(this.HideBinQty=!0);let s=null!=e?e.ID:null,h=null,a=null,n=null;if(82==this.ViewModel.StaticReportType){let t,e;this.dvIssue=this.dvIssueTable=this.dsMain.Tables[1],this.dvIssueColumns=this.dsMain.Columns[1];for(let i=0;i<this.dsMain.Tables[0].length;i++){if(this.ViewModel.process.CancellationPending)return void(this.ViewModel.processArgs.Cancel=!0);e=this.dsMain.Tables[0][i],this.dblQty=parseFloat(e.Quantity),this.dvIssueColumns.Contains("BinInfo")&&(a=null,h=this.FillBinArrays(e[s].toString()));let o=t;t="BatchID="+e.BatchID.toString(),this.BatchConsolidated||(t+=" AND RefInvDocDetailsID="+this.dv[i].InvDocDetailsID.toString()),this.IsBinDetail&&(t+=" AND BinNodeID="+this.dv[i].BinNodeID.toString()),o!=t&&(this.dvIssue=this.dvIssueTable.filter(t=>t.BatchID==e.BatchID),this.BatchConsolidated||(this.dvIssue=this.dvIssue.filter(t=>t.RefInvDocDetailsID==this.dv[i].InvDocDetailsID)),this.IsBinDetail&&(this.dvIssue=this.dvIssue.filter(t=>t.BinNodeID==this.dv[i].BinNodeID)));for(let t=0;t<this.dvIssue.length;t++){let s=this.dvIssue[t];if(null!=h&&(a=this.FillBinArrays(s.BinInfo.toString()),null!=a))for(let t=0;t<h.length;t++){let e={Key:h.keys[t],Value:h.values[t]};e.Value>0&&a.ContainsKey(e.Key)&&a[e.Key]>0&&(e.Value>a[e.Key]?(h[e.Key]=e.Value-a[e.Key],a[e.Key]=0):(a[e.Key]=a[e.Key]-e.Value,h[e.Key]=0))}if(this.dbl=parseFloat(s.Quantity),this.dblQty=this.dblQty-this.dbl,!(this.dblQty>=0)){e.Quantity=0,s.Quantity=-this.dblQty,this.dblQty=0,null!=a&&(s.BinInfo=this.GetBinInfo(a));break}s.Quantity=0,e.Quantity=this.dblQty,e.Value=this.dblQty*parseFloat(this.dv[i].Rate),null!=a&&(s.BinInfo="")}0!=this.dblQty?null!=h&&(e[s]=this.GetBinInfo(h)):(this.dsMain.Tables[0].RemoveAt(i),i--)}if(this.Slabs.length>0){let t=[];"Expired"==this.FilterData?t=this.dsMain.Tables[0].filter(t=>+t.ExpDate>=+this.ViewModel.oReportDialog.ToDate.Date):"Active"==this.FilterData?t=this.dsMain.Tables[0].filter(t=>+t.ExpDate<this.ViewModel.oReportDialog.ToDate.Date):"SelectedSlabActive"==this.FilterData&&(t=this.dsMain.Tables[0].filter(t=>+t.ExpDate<this.ViewModel.oReportDialog.ToDate.Date||t.ExpDate>this.Slabs[this.Slabs.length-1])),t.forEach(t=>{this.dsMain.Tables[0].Remove(t)})}if(this.IsConsolidated){this.dv.SortBy(["ProductName","BatchNumber"]);let t=0,e=null,i=null,o=null,a=null;for(this.k=this.dv.length-1;this.k>=0;this.k--)e=this.dv[this.k].ProductName.toString(),i=this.dv[this.k].BatchNumber.toString(),e==o&&i==a?(null!=s&&(n=this.FillBinArrays(this.dv[this.k][s].toString()),null!=n&&(null==h&&(h=new l.a),n.keys.forEach(t=>{let e={Key:t,Value:n[t]};h.ContainsKey(e.Key)?h[e.Key]+=e.Value:h.push(e.Key,e.Value)}),this.dv[this.k+1][s]=this.GetBinInfo(h))),this.dblQty+=parseFloat(this.dv[this.k].Quantity),t+=parseFloat(this.dv[this.k].Quantity)*parseFloat(this.dv[this.k].Rate),this.dv[this.k+1].Quantity=this.dblQty,this.dv[this.k+1].Value=t,this.dv[this.k+1].Rate=t/this.dblQty,this.dvTable.Remove(this.dv[this.k])):(this.dblQty=parseFloat(this.dv[this.k].Quantity),t=parseFloat(this.dv[this.k].Quantity)*parseFloat(this.dv[this.k].Rate),this.dv[this.k].Rate=t/this.dblQty,null!=s&&(h=this.FillBinArrays(this.dv[this.k][s].toString()))),o=e,a=i}(u=this.ViewModel.ColumnSourceALL.find(t=>"Quantity"==t.ID))&&(u.Formula=""),(u=this.ViewModel.ColumnSourceALL.find(t=>"Value"==t.ID))&&(u.Formula=""),(u=this.ViewModel.ColumnSourceALL.find(t=>"Expired"==t.ID))&&(u.Formula=""),this.ViewModel.ReportData=this.dvTable,this.ViewModel.ReportDataColumns=this.dsMain.Columns[0],this.ViewModel.ConstructFormulaFields(!0),this.AddProductWiseBatchWiseAgeing(),this.ViewModel.process_RunWorkerCompleted()}else if(83==this.ViewModel.StaticReportType){var d=this.ViewModel.BaseReportColumns.find(t=>181==t.CDGDO.FieldValue);let t,e;d&&"2"==d.FormulaEvaluateAtEnd.SelectedValue&&(this.HideBinQty=!0),this.dvIssue=this.dvIssueTable=this.dsMain.Tables[1],this.dvIssueColumns=this.dsMain.Columns[1],this.dsMain.Columns[0].push("Value"),this.dsMain.Columns[0].push("Expired"),this.dsMain.Columns[0].push("S0"),this.dsMain.Columns[0].push("S1"),this.dsMain.Columns[0].push("S2"),this.dsMain.Columns[0].push("S3"),this.dsMain.Columns[0].push("S4"),null!=this.SlabPercent&&(this.dsMain.Columns[0].push("P0"),this.dsMain.Columns[0].push("P1"),this.dsMain.Columns[0].push("P2"),this.dsMain.Columns[0].push("P3"),this.dsMain.Columns[0].push("P4"));for(let l=0;l<this.dsMain.Tables[0].length;l++){if(this.ViewModel.process.CancellationPending)return void(this.ViewModel.processArgs.Cancel=!0);e=this.dsMain.Tables[0][l],this.dblQty=parseFloat(e.Quantity),this.dvIssueColumns.Contains("BinInfo")&&(a=null,h=this.FillBinArrays(e[s].toString())),t="BatchID="+e.BatchID.toString(),this.BatchConsolidated||(t+=" AND RefInvDocDetailsID="+e.InvDocDetailsID.toString()),this.dvIssue=this.dvIssueTable.filter(this.BatchConsolidated?t=>t.BatchID==e.BatchID:t=>t.BatchID==e.BatchID&&t.RefInvDocDetailsID==e.InvDocDetailsID);for(let t=0;t<this.dvIssue.length;t++){let s=this.dvIssue[t];if(null!=h&&(a=this.FillBinArrays(s.BinInfo.toString()),null!=a))for(let t=0;t<h.length;t++){let e={Key:h.keys[t],Value:h.values[t]};e.Value>0&&a.ContainsKey(e.Key)&&a[e.Key]>0&&(e.Value>a[e.Key]?(h[e.Key]=e.Value-a[e.Key],a[e.Key]=0):(a[e.Key]=a[e.Key]-e.Value,h[e.Key]=0))}if(this.dbl=parseFloat(s.Quantity),this.dblQty=this.dblQty-this.dbl,!(this.dblQty>=0)){e.Quantity=0,s.Quantity=-this.dblQty,this.dblQty=0,null!=a&&(s.BinInfo=this.GetBinInfo(a));break}s.Quantity=0,e.Quantity=this.dblQty,null!=a&&(s.BinInfo="")}e.Value=null!=e.Rate?this.dblQty*parseFloat(e.Rate):0,0!=this.dblQty?null!=h&&(e[s]=this.GetBinInfo(h)):(this.dsMain.Tables[0].RemoveAt(l),l--)}let i=new l.a;i.push("-1","Expired"),i.push("0","S0"),i.push("1","S1"),i.push("2","S2"),i.push("3","S3"),i.push("4","S4");let o,n="",r=0;for(this.k=0;this.k<this.dv.length;this.k++){if(this.ViewModel.process.CancellationPending)return void(this.ViewModel.processArgs.Cancel=!0);this.dblQty=parseFloat(this.dv[this.k].Quantity),o=i[this.dv[this.k].ID.toString()],n==this.dv[this.k].ProductID.toString()?(this.dv[r][o]=null==this.dv[r][o]?this.dblQty:parseFloat(this.dv[r][o])+this.dblQty,this.dv[r].Quantity=null==this.dv[r].Quantity?this.dv[this.k].Quantity:parseFloat(this.dv[r].Quantity)+parseFloat(this.dv[this.k].Quantity),this.dv[r].Value=parseFloat(this.dv[r].Value)+parseFloat(this.dv[this.k].Value),this.dvTable.Remove(this.dv[this.k]),this.k--):(r=this.k,n=this.dv[this.k].ProductID.toString(),this.dv[this.k][o]=this.dblQty)}if(null!=this.SlabPercent){let t;for(this.k=0;this.k<this.dv.length;this.k++)if(t=0,null!=this.dv[this.k].Quantity&&(t=parseFloat(this.dv[this.k].Quantity)),null!=this.dv[this.k].Expired&&(t-=parseFloat(this.dv[this.k].Expired)),0!=t)for(let e=0;e<=this.Slabs.length;e++)null!=this.dv[this.k]["S"+e]&&(this.dbl=parseFloat(this.dv[this.k]["S"+e]),this.dbl=100*this.dbl/t,this.dv[this.k]["P"+e]=this.dbl)}this.addProductWiseExpiryAgeing(),this.ViewModel.process_RunWorkerCompleted()}else if(84==this.ViewModel.StaticReportType){let t="";if(this.ViewModel.BaseReportColumns.filter(t=>33==t.ID.length).forEach(e=>{40==e.CDGDO.ParentCostCenterID&&(t.length>0&&(t+=","),t+=e.CDGDO.Column,this.lstPCRates.push(e.ID))}),this.dblS=new Array(this.iSlabs.length+1).fill(0),this.dsMain.Columns[0].push("BalQty"),this.dsMain.Columns[0].push("BalValue"),this.dsMain.Columns[0].push("AvgRate"),null!=this.SlabValue){this.ViewModel.RefreshPostFilters();for(let t=0;t<=this.iSlabs.length;t++)this.dsMain.Columns[0].push("SV"+t)}this.lstParents.Clear(),this.lstTotal.Clear(),this.lstParents.push(this.NewReportRow()),this.lstTotal.push(new Array(this.oColumns.length).fill(0)),this.al=[],this.al.push(""),this.al.push(0),this.al.push(""),this.al.push(this.ViewModel.oReportDialog.StockDimensionID),this.ViewModel.oReportDialog.Locations.Visible&&null!=this.ViewModel.oReportDialog.LocationWhere?o.e.IsEmpty(this.ViewModel.oReportDialog.LocationWhere)?this.al.push(-1):this.al.push(this.ViewModel.oReportDialog.LocationWhere):this.al.push(null),this.al.push(this.AgeingDimWhere),this.al.push(this.strExcludeStockTransfer),this.al.push(this.ViewModel.oReportDialog.ToDate.Date),this.al.push(this.UnPostedDocsInclude),this.al.push(this.DefValuation),this.al.push(0),this.al.push(0),this.al.push(t),this.al.push(t.length>0?this.GetPriceFilter():""),this.al.push(this.CurrencyType),this.al.push(this.ForeignCurrencyID),this.al.push(this.SortTransactionsBy),this.al.push(i.a.SessionManager.UserID),this.al.push(i.a.SessionManager.LanguageID),this.iLoop=0,this.ProductWiseAgeingCallBack()}else if(88==this.ViewModel.StaticReportType)this.AddProductWiseSubstitues(""),this.ViewModel.process_RunWorkerCompleted();else if(114==this.ViewModel.StaticReportType){this.TagID=0;let t="",e="",s="";var u;if((u=this.ViewModel.ReportColumns.filter(t=>"TAG"==t.ID)).length>0){var D=this.ViewModel.BaseReportColumns.filter(t=>"TAG"==t.ID);this.TagID=D[0].CDGDO.ColumnCostCenterID,this.TagID>5e4?t="Code"==D[0].CDGDO.Column?this.GetTagWiseQuery(this.TagID,"Code","Code"):this.GetTagWiseQuery(this.TagID,"Name","Name"):this.TagID=0}this.ViewModel.oReportDialog.Locations.Visible&&null!=this.ViewModel.oReportDialog.LocationWhere&&(e=o.e.IsEmpty(this.ViewModel.oReportDialog.LocationWhere)?" AND dcCCNID"+(this.ViewModel.oReportDialog.Locations.DBColumnID-5e4)+" IN (-1)":" AND dcCCNID"+(this.ViewModel.oReportDialog.Locations.DBColumnID-5e4)+" IN ("+this.ViewModel.oReportDialog.LocationWhere+")",("TRUE"==i.a.SessionManager.Preferences["Division AverageRate"].toUpperCase()&&50001==this.ViewModel.oReportDialog.Locations.DBColumnID||"TRUE"==i.a.SessionManager.Preferences["Location AverageRate"].toUpperCase()&&50002==this.ViewModel.oReportDialog.Locations.DBColumnID||i.a.SessionManager.Preferences["Maintain Dimensionwise AverageRate"]==this.ViewModel.oReportDialog.Locations.DBColumnID.toString())&&(s=e));let l,h=null;this.ViewModel.Preferences.ContainsKey("DontApplyLocationFilter")&&"1"==this.ViewModel.Preferences.DontApplyLocationFilter&&(h=[50002]),e+=this.GetDimensionFilter("DCC.dcCCNID",h),l=this.ViewModel.SelectTag.Replace("@CCWHERE@",e.length>0?" INNER JOIN COM_DocCCData DCC WITH(NOLOCK) ON A.InvDocDetailsID=DCC.InvDocDetailsID "+e:""),this.iLoop=0,this.al=[],this.al.push(""),this.al.push(this.ViewModel.Preferences.ExpectedQTY1),this.al.push(this.ViewModel.Preferences.ExpectedQTY2),this.al.push(this.ViewModel.Preferences.ExpectedQTY3),this.al.push(this.ViewModel.Preferences.CommitedQTY1),this.al.push(this.ViewModel.Preferences.CommitedQTY2),this.al.push(this.ViewModel.Preferences.CommitedQTY3),this.ViewModel.Preferences.ContainsKey("SalesDocs")?this.al.push(this.ViewModel.Preferences.SalesDocs):this.al.push("");var c=this.ViewModel.BaseReportColumns.find(t=>"Months"==t.ID);this.al.push(c&&23824==c.CDGDO.FieldValue?"Gross":"UOMConvertedQty"),this.al.push(this.ViewModel.FromDatePicker.Date),this.al.push(this.ViewModel.ToDatePicker.Date),this.al.push(null!=this.MonthFromDate?this.MonthFromDate:this.ViewModel.FromDatePicker.Date),this.al.push(this.ViewModel.DontApplyDateFilter),this.al.push(this.TagID),this.al.push(t),this.al.push(e),this.al.push(l),this.al.push(this.ViewModel.FromTag),this.al.push(s),this.al.push(i.a.SessionManager.UserID),this.al.push(i.a.SessionManager.LanguageID),this.IsPCodeLink=null!=this.oColumns.find(t=>"ProductCode"==t.ID&&(t.LinkType==r.a.Dimension||t.LinkType==r.a.DimensionNode)),this.IsPNameLink=null!=this.oColumns.find(t=>"ProductName"==t.ID&&(t.LinkType==r.a.Dimension||t.LinkType==r.a.DimensionNode)),this.ShowDetailReport=!(!this.ViewModel.Preferences.ContainsKey("ShowDetailReport")||"1"!=this.ViewModel.Preferences.ShowDetailReport),this.TempRTVisible=this.ViewModel.GrpReportTotal.SubTotalAppearance.IsVisible,this.ItemMasterCallBack()}else if(115==this.ViewModel.StaticReportType){let t="";this.ViewModel.oReportDialog.Locations.Visible&&null!=this.ViewModel.oReportDialog.LocationWhere&&(t=o.e.IsEmpty(this.ViewModel.oReportDialog.LocationWhere)?" AND dcCCNID"+(this.ViewModel.oReportDialog.Locations.DBColumnID-5e4)+" IN (-1)":" AND dcCCNID"+(this.ViewModel.oReportDialog.Locations.DBColumnID-5e4)+" IN ("+this.ViewModel.oReportDialog.LocationWhere+")"),t+=this.GetDimensionFilter("DCC.dcCCNID"),this.al=[],this.al.push(""),this.al.push(this.ViewModel.Preferences.ExpectedQTY1),this.al.push(this.ViewModel.Preferences.ExpectedQTY2),this.al.push(this.ViewModel.Preferences.ExpectedQTY3),this.al.push(this.ViewModel.Preferences.CommitedQTY1),this.al.push(this.ViewModel.Preferences.CommitedQTY2),this.al.push(this.ViewModel.Preferences.CommitedQTY3),this.ViewModel.Preferences.ContainsKey("SalesDocs")?this.al.push(this.ViewModel.Preferences.SalesDocs):this.al.push(""),this.al.push(this.ViewModel.FromDatePicker.Date),this.al.push(this.ViewModel.ToDatePicker.Date),this.al.push(t),this.al.push(i.a.SessionManager.UserID),this.al.push(i.a.SessionManager.LanguageID),this.ExtraColumns=new Array,this.oColumns.forEach(t=>{33==t.ID.length&&this.dsMain.Columns[0].Contains(t.ID)&&this.ExtraColumns.push(t)}),this.iLoop=0,this.SalesAnalysisCallBack()}})}catch(e){return void Logger.ErrorLog("INV_Ageing::Error LoadReport ",e)}}ProductWiseAgeingCallBack(){{if(this.iLoop>=this.dsMain.Tables[0].length)return void this.ProductWiseAgeingCallBack_Complete();if(this.ViewModel.process.CancellationPending)return void(this.ViewModel.processArgs.Cancel=!0);let t;this.sbChunks="";for(let e=this.iLoop;e<this.dsMain.Tables[0].length&&e-this.iLoop<this.ChunkSize;e++)this.ShowLevelTree&&Object(h.j)(this.dsMain.Tables[0][e].IsGroup)||(this.sbChunks.length>0&&(this.sbChunks+=","),this.sbChunks+=this.dsMain.Tables[0][e].ProductID.toString());this.al[0]=this.sbChunks.toString(),i.a.report.GetStockValuation(this.al,this.ViewModel.IsReportDB).then(e=>{this.ds=e,t=this.ds.Tables[0];for(let s=this.iLoop;s<this.dsMain.Tables[0].length&&s-this.iLoop<this.ChunkSize;s++){if(this.drMain=this.dsMain.Tables[0][s],this.strProductID=this.drMain.ProductID.toString(),t=this.ds.Tables[0].filter(t=>t.ProductID==this.strProductID),t.length>0?(this.drMain.BalValue=t[0].BalValue,this.drMain.AvgRate=t[0].AvgRate):this.drMain.AvgRate=0,this.lstPCRates.length>0&&!Object(u.isUndefined)(t.PCxml)){this.lstPCRates.forEach(t=>{this.dsMain.Columns[0].Contains(t)||this.dsMain.Columns[0].push(t)});let e=t[0].PCxml.toString().split(",");for(let t=0;t<this.lstPCRates.length&&t<e.length;t++)this.drMain[this.lstPCRates[t]]=e[t]}this.ViewModel.lstGroup.length>0&&this.ViewModel.AddGroupRows(this.dsMain.Tables[0],s),this.addProductWiseAgeingRow()}this.ViewModel.refreshDataView(),this.iLoop+=this.ChunkSize,this.ProductWiseAgeingCallBack()},t=>{this.ProductWiseAgeingCallBack_Complete()})}}ProductWiseAgeingCallBack_Complete(){this.ShowLevelTree&&this.UpdateTreeTotals(0),this.ViewModel.CheckAndAddTotals(this.dsMain.Tables[0]),this.ViewModel.process_RunWorkerCompleted()}ItemMasterCallBack(){{if(this.iLoop>=this.dsMain.Tables[0].length)return void this.ItemMasterCallBack_Complete();if(this.ViewModel.process.CancellationPending)return void(this.ViewModel.processArgs.Cancel=!0);let t,e,s,o=this.ChunkSize,l=null,h=null,a=null,n=null;this.ChunkSize=this.ViewModel.ReportViewType==r.e.Query?0==this.iLoop?1:o:this.ShowDetailReport?o:1,this.sbChunks="";for(let i=this.iLoop;i<this.dsMain.Tables[0].length&&i-this.iLoop<this.ChunkSize;i++)this.sbChunks.length>0&&(this.sbChunks+=","),this.sbChunks+=this.dsMain.Tables[0][i][this.dsMain.Columns[0][0]].toString();this.al[0]=this.sbChunks.toString(),i.a.report.GetItemMaster(this.al,this.ViewModel.IsReportDB).then(i=>{this.ds=i;for(let t=1;t<this.ds.Columns[1].length;t++)this.ds.Columns[0].push(this.ds.Columns[1][t]);(this.IsPCodeLink||this.IsPNameLink)&&(this.IsPCodeLink&&this.ds.Columns[0].push("ProductCode_ID"),this.IsPNameLink&&this.ds.Columns[0].push("ProductName_ID"),this.ds.Tables[0].forEach(t=>{this.IsPCodeLink&&(t.ProductCode_ID=t.ProductID),this.IsPNameLink&&(t.ProductName_ID=t.ProductID)})),this.dv=this.dvTable=this.ds.Tables[0],t=e=this.ds.Tables[1],s=this.ds.Columns[1],this.dvIssue=this.dvIssueTable=this.ds.Tables[2],h=n=this.ds.Tables[3],this.TagID>0&&(l=a=this.ds.Tables[0]),this.DataSetCollection.push(this.ds);for(let t=0;t<=this.CntMonths;t++)this.ds.Columns[0].push("M"+t);let o;this.ds.Columns[0].push("MonthsTotal"),this.ds.Columns[0].push("AvgMovement"),this.ds.Columns[0].push("Months");for(let r=this.iLoop;r<this.dsMain.Tables[0].length&&r-this.iLoop<this.ChunkSize;r++)if(this.drMain=this.dsMain.Tables[0][r],this.strProductID=this.drMain[this.dsMain.Columns[0][0]].toString(),this.dv=this.dvTable.filter(t=>t.ProductID==this.strProductID),o=0,this.dv.length>0){if(this.TagID>0){let t=this.dv[0];this.dvIssue=this.dvIssueTable.filter(t=>t.ProductID==this.strProductID),this.dvIssue.forEach(e=>{if(l=a.filter(t=>t.ProductID==this.strProductID&&t.TagID==e.TagID),0==l.length){let s;l=a.filter(t=>t.ProductID==this.strProductID&&0==t.TagID),0==l.length?(s=this.ds.Tables[0].NewRow(),s.ProductID=t.ProductID.toString(),s.ProductCode=t.ProductCode.toString(),s.ProductName=t.ProductName.toString(),s.TagID=e.TagID.toString(),this.ds.Tables[0].InsertAt(s,this.ds.Tables[0].indexOf(this.dv[this.dv.length-1]))):(s=l[0],s.TagID=e.TagID.toString()),l=a.filter(t=>t.ProductID==this.strProductID&&t.TagID==e.TagID)}-1!=this.colMonthIndex&&(l[0]["M"+e.Mn.toString()]=e.Qty,null!=e.Qty&&(l[0].Months=null==l[0].Months?parseFloat(e.Qty):parseFloat(l[0].Months)+parseFloat(e.Qty)))}),this.dv.forEach(t=>{h=n.filter(e=>e.ProductID==this.strProductID&&e.TagID==t.TagID),h.length>0&&(t.MonthsTotal=h[0].Qty,t.AvgMovement=parseFloat(h[0].Qty)/(this.CntMonths+1))})}else{let t=0;this.dvIssue=this.dvIssueTable.filter(t=>t.ProductID==this.strProductID),h=n.filter(t=>t.ProductID==this.strProductID),-1!=this.colMonthIndex&&this.dvIssue.forEach(e=>{this.dv[0]["M"+e.Mn.toString()]=e.Qty,null!=e.Qty&&(t+=parseFloat(e.Qty))}),h.length>0&&(this.dv[0].MonthsTotal=h[0].Qty,this.dv[0].AvgMovement=parseFloat(h[0].Qty)/(this.CntMonths+1)),this.dv[0].Months=t}t=e.filter(t=>t.ProductID==this.strProductID),t.length>0&&this.dv.forEach(e=>{for(let i=1;i<s.length;i++)e[s[i]]=t[0][s[i]]})}this.ViewModel.ReportData=this.ds.Tables[0],this.ViewModel.ReportDataColumns=this.ds.Columns[0],this.ViewModel.ConstructFormulaFields(!0),this.dv=this.dvTable,this.ViewModel.RenderData(this.dv,this.ds.Columns[0]),this.iLoop+this.ChunkSize<this.dsMain.Tables[0].length&&(this.ViewModel.GrpReportTotal.SubTotalAppearance.IsVisible=!1,this.ViewModel.CheckAndAddTotals(this.dv),this.ViewModel.GrpReportTotal.SubTotalAppearance.IsVisible=this.TempRTVisible),this.ViewModel.refreshDataView(),this.iLoop+=this.ChunkSize,this.ItemMasterCallBack()})}}ItemMasterCallBack_Complete(){this.ViewModel.CheckAndAddTotals(this.dv),this.ViewModel.process_RunWorkerCompleted()}SalesAnalysisCallBack(){if(this.iLoop>=this.dsMain.Tables[0].length)this.SalesAnalysisCallBack_Complete();else if(this.ViewModel.process.CancellationPending)this.ViewModel.processArgs.Cancel=!0;else{this.sbChunks="";for(let t=this.iLoop;t<this.dsMain.Tables[0].length&&t-this.iLoop<this.ChunkSize;t++)this.sbChunks.length>0&&(this.sbChunks+=","),this.sbChunks+=this.dsMain.Tables[0][t][this.dsMain.Columns[0][0]].toString();this.al[0]=this.sbChunks.toString(),i.a.report.GetSalesAnalasys(this.al,this.ViewModel.IsReportDB).then(t=>{this.ds=t,this.dv=this.dvTable=this.ds.Tables[0],this.dvIssue=this.dvIssueTable=this.ds.Tables[1],this.dvIssueColumns=this.ds.Columns[1],this.DataSetCollection.push(this.ds);for(let s=0;s<=this.CntMonths;s++)this.ds.Columns[0].push("M"+s);let e;this.ds.Columns[0].push("AvgMovement"),this.ds.Columns[0].push("MonthsTotal"),this.ExtraColumns.forEach(t=>{this.ds.Columns[0].Contains(t.ID)||this.ds.Columns[0].push(t.ID)});for(let s=this.iLoop;s<this.dsMain.Tables[0].length&&s-this.iLoop<this.ChunkSize;s++)this.drMain=this.dsMain.Tables[0][s],this.strProductID=this.drMain[this.dsMain.Columns[0][0]].toString(),this.dv=this.dvTable.filter(t=>t.ProductID==this.strProductID),e=0,this.dv.length>0&&(this.dvIssue=this.dvIssueTable.filter(t=>t.ProductID==this.strProductID),this.dvIssue.forEach(t=>{this.dv[0]["M"+t.Mn.toString()]=t.Qty,e+=parseFloat(t.Qty)}),this.dv[0].MonthsTotal=e,this.dv[0].AvgMovement=e/this.CntMonths,this.ExtraColumns.forEach(t=>{this.dv[0][t.ID]=this.drMain[t.ID].toString()}));this.ViewModel.ReportData=this.ds.Tables[0],this.ViewModel.ReportDataColumns=this.ds.Columns[0],this.ViewModel.ConstructFormulaFields(!0),this.dv=this.dvTable,this.ViewModel.RenderData(this.dv,this.ds.Columns[0]),this.ViewModel.refreshDataView(),this.iLoop+=this.ChunkSize,this.SalesAnalysisCallBack()})}}SalesAnalysisCallBack_Complete(){this.ViewModel.ReportData=null,this.ViewModel.GrpReportTotal.SubTotalAppearance.IsVisible&&this.ViewModel.AddSubtotals_RT(this.ViewModel.GrpReportTotal,0),this.ViewModel.process_RunWorkerCompleted()}FillBinArrays(t){let e;if(t.length>0){let s=t.split(",");e=new l.a;for(let t=0;t<s.length;t++){let i=s[t].indexOf("-"),o=parseFloat(s[t].substr(i+1));s[t]=s[t].substr(0,i+1).TrimStart(" "),e.ContainsKey(s[t])?e[s[t]]+=o:e.push(s[t],o)}}else e=null;return e}GetBinInfo(t){let e="";return null!=t&&t.keys.forEach(s=>{let i={Key:s,Value:t[s]};i.Value>0&&(e.length>0&&(e+=", "),e+=this.HideBinQty?i.Key.TrimEnd("-"):i.Key+i.Value)}),e}LoadReportWithPostFilters(t){if(this.GrdRow=-1,this.AggTotal=o.e.NumArray(this.oColumns.length,2),this.ViewModel.ClearRows(),this.ViewModel.totals=o.e.NumArray(this.oColumns.length,this.ViewModel.lstGroup.length+1),this.dv=D.a.FilterData(this.dvTable,this.ViewModel.PostDataFetchFilterFields),null!=this.lstTotal&&(this.lstTotal.Clear(),this.lstParents.Clear(),this.lstParents.push(this.NewReportRow()),this.lstTotal.push(new Array(this.oColumns.length).fill(0))),82==this.ViewModel.StaticReportType)this.AddProductWiseBatchWiseAgeing();else if(83==this.ViewModel.StaticReportType)this.addProductWiseExpiryAgeing();else if(84==this.ViewModel.StaticReportType)this.addProductWiseAgeing();else if(88==this.ViewModel.StaticReportType)this.AddProductWiseSubstitues(t);else if(114==this.ViewModel.StaticReportType){this.ViewModel.Preferences.ContainsKey("ShowDetailReport");let t=this.ViewModel.GrpReportTotal.SubTotalAppearance.IsVisible;for(let e=0,s=0;e<this.dsMain.Tables[0].length;e+=this.ChunkSize,s++)this.ds=this.DataSetCollection[s],this.dv=this.ds.Tables[0],this.ViewModel.ReportData=this.ds.Tables[0],this.dv=D.a.FilterData(this.dv,this.ViewModel.PostDataFetchFilterFields),this.ViewModel.RenderData(this.dv),e+this.ChunkSize<this.dsMain.Tables[0].length&&(this.ViewModel.GrpReportTotal.SubTotalAppearance.IsVisible=!1,this.ViewModel.CheckAndAddTotals(this.dv),this.ViewModel.GrpReportTotal.SubTotalAppearance.IsVisible=t);this.ViewModel.CheckAndAddTotals(this.dv)}else if(115==this.ViewModel.StaticReportType){for(let t=0,e=0;t<this.dsMain.Tables[0].length;t+=this.ChunkSize,e++)this.ds=this.DataSetCollection[e],this.dv=this.ds.Tables[0],this.ViewModel.ReportData=this.ds.Tables[0],this.dv=D.a.FilterData(this.dv,this.ViewModel.PostDataFetchFilterFields),this.ViewModel.RenderData(this.dv);this.ViewModel.CheckAndAddTotals(this.dv)}this.ViewModel.refreshDataView()}GetQuery(){let t="",e="",s="",i=this.ViewModel.oReportDialog.GetSeqNosListWithRoots();this.ViewModel.oReportDialog.IsZeroSelected||this.ViewModel.oReportDialog.IsOneSelected||(this.ViewModel.oReportDialog.IsGroupExists?(s=" AND P.ProductID=GTP.GTID",e=i.Contains(",")?",(select T.ProductID GTID from INV_Product T with(nolock),INV_Product GT1 with(nolock) where T.lft BETWEEN GT1.lft AND GT1.rgt AND GT1.ProductID IN ("+i+") group by T.ProductID) AS GTP ":",(select T.ProductID GTID from INV_Product T with(nolock),INV_Product GT1 with(nolock) where T.lft BETWEEN GT1.lft AND GT1.rgt AND GT1.ProductID="+i+" group by T.ProductID) AS GTP "):s=i.Contains(",")?" AND P.ProductID IN ("+i+")":" AND P.ProductID="+i);let l=this.ViewModel.GetCostCenterFilter(113,"D.StatusID");if(0==l.length&&(l=" and D.StatusID=369"),82==this.ViewModel.StaticReportType){let i="",h="",a="",n="D.UOMConvertedQty";this.ViewModel.oReportDialog.Locations.Visible&&null!=this.ViewModel.oReportDialog.LocationWhere&&(a=o.e.IsEmpty(this.ViewModel.oReportDialog.LocationWhere)?" AND 1<>1":" AND DCC.dcCCNID"+(this.ViewModel.oReportDialog.Locations.DBColumnID-5e4)+" IN ("+this.ViewModel.oReportDialog.LocationWhere+")"),a+=this.GetDimensionFilter("DCC.dcCCNID"),h+=a,(h.length>0||this.ViewModel.FromTag.Contains("DCC.dcCCNID"))&&(i=" INNER JOIN COM_DocCCData DCC WITH(NOLOCK) ON D.InvDocDetailsID=DCC.InvDocDetailsID "+this.ViewModel.FromTag),s=s.Replace("P.ProductID","B.ProductID"),t+="DECLARE @AsOn FLOAT\nSET @AsOn=CONVERT(FLOAT,CONVERT(DATETIME,'"+this.ViewModel.oReportDialog.ToDate.Date.ToString("dd MMM yyyy")+"'))",this.ViewModel.GroupFromTag.Contains("BIN.NodeID")?(this.IsBinDetail=!0,n="isnull(BD.Quantity*D.UOMConversion,D.UOMConvertedQty)",this.ViewModel.SelectTag+=",isnull(BIN.NodeID,0) BinNodeID"):this.IsBinDetail=!1,t+="\nSELECT 'Code :'+P.ProductCode+'    Name :'+P.ProductName ProductName,B.BatchNumber,B.BatchID,D.InvDocDetailsID,CONVERT(DATETIME,B.ExpiryDate) ExpDate,CONVERT(DATETIME,B.MfgDate) MfgDate,"+n+" Quantity,D.Rate,"+n+"*D.Rate Value\n"+this.ViewModel.SelectTag+this.ViewModel.GroupSelectTag+"\nFROM INV_DocDetails D WITH(NOLOCK)\nINNER JOIN INV_Batches B  WITH(NOLOCK) ON B.BatchID=D.BatchID\nINNER JOIN INV_Product P WITH(NOLOCK) ON B.ProductID=P.ProductID"+i+this.ViewModel.GroupFromTag+e,t+=" WHERE D.BatchID>1 and D.VoucherType=1 AND D.IsQtyIgnored=0 AND D.DocDate<=@AsOn and B.ExpiryDate is not null"+l,s.length>0&&(t+=s),t+=h,t+=this.IsBinDetail?" Order By P.ProductName,D.DocDate,BatchNumber,BinNodeID,D.Rate,B.MfgDate":" Order By P.ProductName,D.DocDate,BatchNumber,D.Rate,B.MfgDate",this.IsBinDetail&&(i+="  left join INV_BinDetails BD with(nolock) on BD.InvDocDetailsID=D.InvDocDetailsID"),this.BatchConsolidated?(t+="\nSELECT B.BatchID,SUM("+n+") Quantity",this.IsBinDetail&&(t+=",isnull(BD.BinID,0) BinNodeID"),t+="\nFROM INV_DocDetails D WITH(NOLOCK)\nINNER JOIN INV_Batches B  WITH(NOLOCK) ON B.BatchID=D.BatchID\nINNER JOIN INV_Product P WITH(NOLOCK) ON B.ProductID=P.ProductID"+i+e,t+=" WHERE D.BatchID>1 and D.VoucherType=-1 AND D.IsQtyIgnored=0 AND D.DocDate<=@AsOn AND (D.RefInvDocDetailsID=0 OR D.RefInvDocDetailsID IS NULL) "+s,t+=h+l,t+=" GROUP BY B.BatchID",this.IsBinDetail&&(t+=",BD.BinID")):(t+="\nSELECT D.InvDocDetailsID,D.RefInvDocDetailsID, B.BatchID,"+n+" Quantity",this.IsBinDetail?t+=",isnull(BD.BinID,0) BinNodeID":this.ViewModel.ReportParams.ContainsKey("BinInfo")&&this.ViewModel.ReportParams.BinInfo.length>0&&(t+=","+this.ViewModel.ReportParams.BinInfo+" BinInfo"),t+="\nFROM INV_DocDetails D WITH(NOLOCK)\nINNER JOIN INV_Batches B  WITH(NOLOCK) ON B.BatchID=D.BatchID\nINNER JOIN [INV_Product] P WITH(NOLOCK) ON B.ProductID=P.ProductID"+i+e,t+=" WHERE D.BatchID>1 and D.VoucherType=-1 AND D.IsQtyIgnored=0 AND D.DocDate<=@AsOn AND D.RefInvDocDetailsID>0 "+s,t+=h+l)}else if(83==this.ViewModel.StaticReportType){let i="";this.ViewModel.oReportDialog.Locations.Visible&&null!=this.ViewModel.oReportDialog.LocationWhere&&(i=o.e.IsEmpty(this.ViewModel.oReportDialog.LocationWhere)?" AND 1<>1":" AND DCC.dcCCNID"+(this.ViewModel.oReportDialog.Locations.DBColumnID-5e4)+" IN ("+this.ViewModel.oReportDialog.LocationWhere+")"),i+=this.GetDimensionFilter("DCC.dcCCNID"),i.length>0&&(i=" INNER JOIN COM_DocCCData DCC WITH(NOLOCK) ON D.InvDocDetailsID=DCC.InvDocDetailsID "+i);let h=this.BatchConsolidated?"":"D.InvDocDetailsID,";this.ViewModel.ReportParams.ContainsKey("BinInfo"),t+="declare @AsOn FLOAT\ndeclare @Tbl As Table(ID INT,FromDate FLOAT,ToDate FLOAT)\nset @AsOn=CONVERT(FLOAT,CONVERT(DATETIME,'"+this.ViewModel.oReportDialog.ToDate.Date.ToString("dd MMM yyyy")+"'))",t+="\nINSERT INTO @Tbl VALUES(-1,0,@AsOn-1)\nINSERT INTO @Tbl VALUES(0,@AsOn,@AsOn+"+(this.iSlabs[0]-1)+")\nINSERT INTO @Tbl VALUES(1,@AsOn+"+this.iSlabs[0]+",@AsOn+"+(this.iSlabs[1]-1)+")\nINSERT INTO @Tbl VALUES(2,@AsOn+"+this.iSlabs[1]+",@AsOn+"+(this.iSlabs[2]-1)+")\nINSERT INTO @Tbl VALUES(3,@AsOn+"+this.iSlabs[2]+",@AsOn+"+(this.iSlabs[3]-1)+")\nINSERT INTO @Tbl VALUES(4,@AsOn+"+this.iSlabs[3]+",123456)\n",t+="SELECT "+h+"T.ID,D.ProductID,B.BatchID,P.ProductCode,P.ProductName,SUM(D.UOMConvertedQty) Quantity,MAX(D.Rate) Rate\n"+this.ViewModel.GroupSelectTag+"\nFROM INV_DocDetails D WITH(NOLOCK) "+i+"\nINNER JOIN INV_Batches B WITH(NOLOCK) ON B.BatchID=D.BatchID\nINNER JOIN @Tbl T ON B.ExpiryDate BETWEEN T.FromDate AND T.ToDate\n",t+=this.ShowLevelTree?" RIGHT JOIN INV_Product P WITH(NOLOCK) ON P.ProductID=D.ProductID":" INNER JOIN INV_Product P WITH(NOLOCK) ON P.ProductID=D.ProductID",t+=this.ViewModel.FromTag+this.ViewModel.GroupFromTag,t+=e,t+="\nWHERE D.BatchID>1 and (D.VoucherType=1 and D.IsQtyIgnored=0) AND D.DocDate<=@AsOn and B.ExpiryDate is not null",t+=l,this.ShowLevelTree?t+=" AND P.ProductID<>1 AND (D.Quantity IS NOT NULL OR P.IsGroup=1)"+s:s.length>0&&(t+=s),t+="\nGROUP BY "+h+"D.ProductID,B.BatchID,P.ProductCode,P.ProductName,T.ID,D.DocDate,D.Rate\nORDER BY P.ProductName,D.ProductID,B.BatchID,D.DocDate,T.ID,Rate",this.BatchConsolidated?(t+="\nSELECT B.BatchID,SUM(D.UOMConvertedQty) Quantity\nFROM INV_DocDetails D WITH(NOLOCK)"+i+"\nINNER JOIN INV_Batches B  WITH(NOLOCK) ON B.BatchID=D.BatchID\nINNER JOIN INV_Product P WITH(NOLOCK) ON B.ProductID=P.ProductID"+e,t+=" WHERE D.BatchID>1 and D.VoucherType=-1 AND D.IsQtyIgnored=0 AND D.DocDate<=@AsOn AND (D.RefInvDocDetailsID=0 OR D.RefInvDocDetailsID IS NULL) ",t+=l,t+=s,t+=" GROUP BY B.BatchID"):this.ViewModel.ReportParams.ContainsKey("BinInfo")&&this.ViewModel.ReportParams.BinInfo.length>0?(t+="\nSELECT D.RefInvDocDetailsID,B.BatchID,D.UOMConvertedQty Quantity,"+this.ViewModel.ReportParams.BinInfo+" BinInfo\nFROM INV_DocDetails D WITH(NOLOCK)"+i+"\nINNER JOIN INV_Batches B  WITH(NOLOCK) ON B.BatchID=D.BatchID\nINNER JOIN INV_Product P WITH(NOLOCK) ON B.ProductID=P.ProductID"+e,t+=" WHERE D.BatchID>1 and D.VoucherType=-1 AND D.IsQtyIgnored=0 AND D.DocDate<=@AsOn AND D.RefInvDocDetailsID>0 ",t+=l,t+=s):(t+="\nSELECT D.RefInvDocDetailsID,B.BatchID,SUM(D.UOMConvertedQty) Quantity\nFROM INV_DocDetails D WITH(NOLOCK)"+i+"\nINNER JOIN INV_Batches B  WITH(NOLOCK) ON B.BatchID=D.BatchID\nINNER JOIN INV_Product P WITH(NOLOCK) ON B.ProductID=P.ProductID"+e,t+=" WHERE D.BatchID>1 and D.VoucherType=-1 AND D.IsQtyIgnored=0 AND D.DocDate<=@AsOn AND D.RefInvDocDetailsID>0 ",t+=l,t+=s,t+=" GROUP BY D.RefInvDocDetailsID,B.BatchID")}else if(84==this.ViewModel.StaticReportType){let i="",h=!1,a=!1,n=!1;this.ViewModel.Preferences.ContainsKey("DisplayStock")&&(this.ViewModel.Preferences.DisplayStock.Contains("Zero")&&(n=!0),this.ViewModel.Preferences.DisplayStock.Contains("Positive")&&(h=!0),this.ViewModel.Preferences.DisplayStock.Contains("Negative")&&(a=!0),h||a||n||(h=a=n=!0));let r=0,u="",D="",I="",C="",p="",M="",T="";this.ViewModel.oReportDialog.Locations.Visible&&null!=this.ViewModel.oReportDialog.LocationWhere&&(T=o.e.IsEmpty(this.ViewModel.oReportDialog.LocationWhere)?" AND 1<>1":" AND DCC.dcCCNID"+(this.ViewModel.oReportDialog.Locations.DBColumnID-5e4)+" IN ("+this.ViewModel.oReportDialog.LocationWhere+")"),T+=this.GetDimensionFilter("DCC.dcCCNID"),1==this.ViewModel.ReportGroups.length&&this.ViewModel.ReportGroups[0].CDGDO.ColumnCostCenterID>5e4&&(r=this.ViewModel.ReportGroups[0].CDGDO.ColumnCostCenterID,D=",DCC.dcCCNID"+(r-5e4)+" TAGID",I=",DCC.dcCCNID"+(r-5e4),C=",TAGID",u=c.GetTagTableName(r),p=",TG.Name AS "+this.ViewModel.ReportGroups[0].ID,M="TG.Name,",u=" INNER JOIN "+c.GetTagTableName(r)+" TG WITH(NOLOCK) ON TG.NodeID=TBL.TagID"),r>0&&(this.ShowLevelTree=!1),this.AgeingDimWhere=T,(r>0||T.length>0)&&(T=" INNER JOIN COM_DocCCData DCC WITH(NOLOCK) ON D.InvDocDetailsID=DCC.InvDocDetailsID "+T),this.ForeignCurrencyID>0&&(i+=" AND D.CurrencyID="+this.ForeignCurrencyID),i+=l,this.strExcludeStockTransfer=d.a.GetExcludeStockTransfer(this.ViewModel),i+=this.strExcludeStockTransfer,this.ViewModel.Preferences.ContainsKey("ExcludeOtherTransferInSales")&&this.ViewModel.Preferences.ExcludeOtherTransferInSales.length>0&&(i+=" AND D.CostCenterID NOT IN ("+this.ViewModel.Preferences.ExcludeOtherTransferInSales+")"),null!=this.ViewModel.ColumnSource.find(t=>"SerialNumbers"==t.ID&&t.HeaderAppearance.IsVisible)&&(this.ViewModel.SelectTag+=",STUFF(\n(select ', '+S.SerialNumber from INV_SerialStockProduct S with(nolock)\ninner join Inv_DocDetails D with(nolock) on D.InvDocDetailsID=S.InvDocDetailsID\nwhere S.IsAvailable=1 and D.ProductID=P.ProductID FOR XML PATH('')),1,1,'') SerialNumbers"),t+="DECLARE @AsOn FLOAT\nSET @AsOn=CONVERT(FLOAT,CONVERT(DATETIME,'"+this.ViewModel.oReportDialog.ToDate.Date.ToString("dd MMM yyyy"),t+="')) \nSELECT P.ProductCode,P.ProductName"+p+",P.ProductID"+this.ViewModel.SelectTag;for(let e=0;e<=this.iSlabs.length;e++)t+=",S"+e;if(t+=",Issue",this.ShowLevelTree&&(t+=",P.IsGroup,P.Depth"),this.ShowYearWise){t+=" FROM ( SELECT ProductID"+C;for(let e=0;e<=this.iSlabs.length;e++)t+=",SUM(S"+e+") S"+e;t+=",SUM(Issue) Issue FROM (";for(let e=0;e<=this.iSlabs.length;e++){e>0&&(t+="\nUNION ALL "),t+="\nSELECT D.ProductID"+D;for(let s=0;s<=this.iSlabs.length;s++)t+=e==s?",SUM(D.UOMConvertedQty) S"+s:",0 S"+s;t+=",0 Issue",t+="\nFROM INV_DocDetails D WITH(NOLOCK) "+T+"\nWHERE D.VoucherType=1 and D.IsQtyIgnored=0 AND ",t+=0==e?"(D.DocDate<=@AsOn AND D.DocDate>=convert(float,convert(datetime,'"+this.Slabs[e].ToString("dd MMM yyyy")+"')))":e==this.iSlabs.length?"D.DocDate<convert(float,convert(datetime,'"+this.Slabs[e-1].ToString("dd MMM yyyy")+"'))":"(D.DocDate<convert(float,convert(datetime,'"+this.Slabs[e-1].ToString("dd MMM yyyy")+"')) AND D.DocDate>=convert(float,convert(datetime,'"+this.Slabs[e].ToString("dd MMM yyyy")+"')))",t+=i,t+=" GROUP BY D.ProductID"+I}t+="\nUNION ALL\nSELECT D.ProductID"+D;for(let e=0;e<=this.iSlabs.length;e++)t+=",0 S"+e;t+=",SUM(D.UOMConvertedQty) Issue\nFROM INV_DocDetails D WITH(NOLOCK) "+T+"\nWHERE D.VoucherType=-1 and D.IsQtyIgnored=0 AND D.DocDate<=@AsOn"+i+"\nGROUP BY D.ProductID"+I+"\n\n) AS TBL2\nGROUP BY  ProductID"+C+") AS TBL"}else{let e=this.iSlabs[0],s="";t+=" FROM ( SELECT ProductID"+C;for(let i=0;i<=this.iSlabs.length;i++)t+=",SUM(S"+i+") S"+i,s+="SLAB S"+i+",";t+=",SUM(Issue) Issue FROM (\n\nSELECT D.ProductID"+D+","+s.Replace("SLAB S0,","SUM(D.UOMConvertedQty) S0,").Replace("SLAB","0")+"0 Issue\nFROM INV_DocDetails D WITH(NOLOCK) "+T+"\nWHERE D.VoucherType=1 and D.IsQtyIgnored=0 AND (D.DocDate<=@AsOn AND D.DocDate>@AsOn-"+this.iSlabs[0]+")"+i+"\nGROUP BY D.ProductID"+I;for(let o=1;o<this.iSlabs.length;o++)this.iSlabs[o]>this.iSlabs[o-1]&&(e=this.iSlabs[o],t+="\nUNION\nSELECT D.ProductID"+D+","+s.Replace("SLAB S"+o+",","SUM(D.UOMConvertedQty) S"+o+",").Replace("SLAB","0"),t+="0 Issue\nFROM INV_DocDetails D WITH(NOLOCK) "+T+"\nWHERE D.VoucherType=1 and D.IsQtyIgnored=0 AND (D.DocDate<=@AsOn-"+this.iSlabs[o-1]+" AND D.DocDate>@AsOn-"+this.iSlabs[o]+")"+i+"\nGROUP BY D.ProductID"+I);t+="\nUNION\nSELECT D.ProductID"+D+","+s.Replace("SLAB S"+this.iSlabs.length+",","SUM(D.UOMConvertedQty) S"+this.iSlabs.length+",").Replace("SLAB","0")+"0 Issue\nFROM INV_DocDetails D WITH(NOLOCK) "+T+"\nWHERE D.VoucherType=1 and D.IsQtyIgnored=0 AND (D.DocDate<=@AsOn-"+e+")"+i+"\nGROUP BY D.ProductID"+I+"\nUNION\nSELECT D.ProductID"+D+","+s.Replace("SLAB","0")+"SUM(D.UOMConvertedQty) Issue\nFROM INV_DocDetails D WITH(NOLOCK) "+T+"\nWHERE D.VoucherType=-1 and D.IsQtyIgnored=0 AND D.DocDate<=@AsOn"+i+"\nGROUP BY D.ProductID"+I+"\n\n) AS TBL2\nGROUP BY  ProductID"+C+") AS TBL"}let S="";if(!h||!a||!n){let t="S0";for(let e=1;e<=this.iSlabs.length;e++)t+="+S"+e;h&&(S="("+t+"-Issue)>0"),a&&(S.length>0&&(S+=" OR "),S+="("+t+"-Issue)<0"),n&&(S.length>0&&(S+=" OR "),S+="("+t+"-Issue)=0")}this.ShowLevelTree?(t+=" RIGHT JOIN INV_Product P WITH(NOLOCK) ON P.ProductID=TBL.ProductID"+this.ViewModel.FromTag+e,t+=" WHERE P.ProductID<>1 AND P.ProductTypeID!=6 AND P.ProductTypeId!=10 AND ",t+="((TBL.S0 IS NOT NULL",S.length>0&&(t+=" AND ("+S+")"),t+=")",t+="OR P.IsGroup=1)",t+=s,o.e.IsEmpty(this.ViewModel.RowFiltersWhere)||(t+=" AND "+this.ViewModel.RowFiltersWhere),t+=" ORDER BY P.lft"):(t+=" INNER JOIN INV_Product P WITH(NOLOCK) ON P.ProductID=TBL.ProductID"+u+this.ViewModel.FromTag+e,t+=" WHERE P.ProductTypeID!=6 AND P.ProductTypeId!=10 and P.IsGroup=0"+s,S.length>0&&(t+=" AND ("+S+")"),o.e.IsEmpty(this.ViewModel.RowFiltersWhere)||(t+=" AND "+this.ViewModel.RowFiltersWhere))}else 88==this.ViewModel.StaticReportType?(t+="SELECT MS.[ProductID],S.[ProductID] SProductID,P.ProductCode SCode,P.ProductName SName,ISNULL((SELECT SUM(INV.UOMConvertedQty*INV.VoucherType) QOH FROM INV_DocDetails INV WITH(NOLOCK)\nWHERE INV.ProductID=S.ProductID),0) QOH\nFROM [INV_ProductSubstitutes] MS WITH(NOLOCK)\nLEFT JOIN [INV_ProductSubstitutes] S WITH(NOLOCK) ON MS.[SubstituteGroupID]=S.[SubstituteGroupID] --AND MS.[ProductID]<>S.[ProductID]\nINNER JOIN INV_Product P WITH(NOLOCK) ON P.[ProductID]=S.[ProductID]"+e,s.length>0&&(s=s.Replace("P.ProductID","MS.ProductID"),t+=" WHERE 1=1 "+s),t+=" GROUP BY  MS.[ProductID],S.[ProductID],P.ProductCode,P.ProductName",t+="\nSELECT MS.[ProductID],MS.[SubstituteGroupName] FROM [INV_ProductSubstitutes] MS WITH(NOLOCK)"+e,s.length>0&&(t+=" WHERE 1=1"+s),t+=" group by MS.[ProductID],MS.[SubstituteGroupName]"):114==this.ViewModel.StaticReportType?this.ViewModel.ReportViewType!=r.e.Query||i.Contains(",")||"1"==i?this.ViewModel.Preferences.ContainsKey("ShowDetailReport")&&"1"==this.ViewModel.Preferences.ShowDetailReport?(t+="SELECT P.ProductID,P.ProductName FROM INV_Product P WITH(NOLOCK)"+e,t+=" WHERE P.IsGroup=0"+s,t+=" Order By P.lft"):(this.LevelNo=6,this.ViewModel.Preferences.ContainsKey("Level")&&o.e.IsNum(this.ViewModel.Preferences.Level)&&(this.LevelNo=o.e.Int(this.ViewModel.Preferences.Level)),t+="SELECT P.ProductID,P.ProductName FROM INV_Product P WITH(NOLOCK)"+e,t+=" WHERE P.IsGroup=1 AND P.Depth<="+this.LevelNo+s,t+=" Order By P.ProductName"):this.ViewModel.Preferences.ContainsKey("ShowDetailReport")&&"1"==this.ViewModel.Preferences.ShowDetailReport?t+="select ProductID,ProductName,lft from INV_Product WITH(NOLOCK) where productid="+i+" OR (IsGroup=0 and lft>(select lft from inv_product WITH(NOLOCK) where productid="+i+") and rgt<(select rgt from inv_product WITH(NOLOCK) where productid="+i+")) order by lft":t+="select ProductID,ProductName from INV_Product WITH(NOLOCK) where productid="+i:115==this.ViewModel.StaticReportType&&(t+="SELECT P.ProductID,P.ProductName,P.ValuationID "+this.ViewModel.SelectTag+" FROM INV_Product P WITH(NOLOCK)"+e,t+=this.ViewModel.FromTag,t+=" WHERE P.IsGroup=0 "+s,t+=" Order By P.ProductName");return t.toString()}AddReportTotals(){this.UpdateTreeTotals(0),this.row=this.NewReportRow_2(n.f.ReportTotal,this.ViewModel.GrpReportTotal.SubTotalAppearance),this.ViewModel.GrpReportTotal.Height>0&&(this.row.Height=this.ViewModel.GrpReportTotal.Height),this.row.LevelNo=0;let t=-1;for(this.k=0;this.k<this.ViewModel.ColumnSource.length;this.k++)this.ViewModel.GrpReportTotal.TotalCols.ContainsKey(this.oColumns[this.k].ID)&&(-1==t&&(t=this.k),this.row.Cells[this.k].CellAppearance.Alignment="Right",this.ViewModel.SetCellValue(this.lstTotal[0][this.k].toString(),this.oColumns[this.k].DataFormat,this.oColumns[this.k].ColumnType,this.row.Cells[this.k]));for(this.k=this.ViewModel.ColumnSource.length;this.k<this.oColumns.length;this.k++)-1==t&&(t=this.k),this.row.Cells[this.k].CellAppearance.Alignment="Right",this.ViewModel.SetCellValue(this.lstTotal[0][this.k].toString(),this.oColumns[this.k].DataFormat,this.oColumns[this.k].ColumnType,this.row.Cells[this.k]);this.row.Cells[0].Text=i.a.GetResource("Reports_ReportTotal"),t>0&&(this.GrdRow++,this.row.Cells[0].ColSpan=t,this.ViewModel.addRow(this.row))}addProductWiseAgeingRow(){if(this.oRow=this.NewReportRow(),this.oRow.Height=this.ViewModel.RowHeight,this.ShowLevelTree&&(this.oRow.LevelNo=parseInt(this.drMain.Depth)-1,this.oRow.Cells[1].IsNormal=!1,this.oRow.IsGroup=Object(h.j)(this.drMain.IsGroup),this.oRow.Cells[1].level=this.oRow.LevelNo,this.UpdateTreeTotals(this.oRow.LevelNo),this.lstParents.length>0&&(this.oRow.Parent=this.lstParents[this.lstParents.length-1]),Object(h.j)(this.drMain.IsGroup))){this.lstParents.push(this.oRow),this.lstTotal.push(new Array(this.oColumns.length).fill(0)),this.oRow.Type=n.f.BalanceBF;for(let t=0;t<this.oRow.Cells.length;t++)this.oRow.Cells[t].IsNormal=!1,this.oRow.Cells[t].CellAppearance=this.oColumns[t].DataAppearance.Clone(),this.oRow.Cells[t].CellAppearance.ForeColor=this.BalanceBFAppearance.ForeColor}if(!this.oRow.IsGroup){this.dbl=0;for(let t=0;t<=this.iSlabs.length;t++)this.dblS[t]=parseFloat(this.drMain["S"+t]),this.dbl+=this.dblS[t];this.dblIssue=parseFloat(this.drMain.Issue),this.dbl=this.dbl-this.dblIssue,this.drMain.BalQty=this.dbl;for(let t=this.iSlabs.length;t>=0;t--){if(this.dbl=parseFloat(this.drMain["S"+t]),this.dblIssue=this.dblIssue-this.dbl,!(this.dblIssue>=0)){this.drMain["S"+t]=-this.dblIssue;break}0==t&&this.dblIssue>0?this.drMain.S0=-this.dblIssue:this.drMain["S"+t]=0}if(null!=this.SlabValue){this.dblAvgRate=parseFloat(this.drMain.AvgRate);for(let t=0;t<=this.iSlabs.length;t++)this.drMain["SV"+t]=this.dblAvgRate*parseFloat(this.drMain["S"+t])}}this.oRow.NodeID=parseInt(this.drMain.ProductID);for(let t=0;t<this.oColumns.length;t++)this.CellValue=null,Object(u.isUndefined)(this.drMain[this.oColumns[t].ID])||(this.CellValue=this.drMain[this.oColumns[t].ID]),null!=this.CellValue&&(this.ViewModel.SetCellValue(this.CellValue,this.oColumns[t].DataFormat,this.oColumns[t].ColumnType,this.oRow.Cells[t]),o.e.IsNum(this.CellValue)&&(this.dbl=o.e.Double(this.CellValue),this.lstTotal.length>0&&(this.lstTotal[this.lstTotal.length-1][t]+=this.dbl),this.ViewModel.totals[t][this.ViewModel.lstGroup.length]+=this.dbl));this.oRow.LevelNo<=this.LevelNo&&(this.oRow.IsGroup||this.ViewModel.ApplyKPI(this.oRow),this.GrdRow++,this.ViewModel.addRow(this.oRow))}addProductWiseAgeing(){let t;for(this.lstParents.Clear(),this.lstTotal.Clear(),this.lstParents.push(this.NewReportRow()),this.lstTotal.push(new Array(this.oColumns.length).fill(0)),this.k=0;this.k<this.dv.length;this.k++){if(this.oRow=this.NewReportRow(),this.oRow.Height=this.ViewModel.RowHeight,this.ShowLevelTree&&(this.oRow.LevelNo=parseInt(this.dv[this.k].Depth)-1,this.oRow.Cells[1].IsNormal=!1,this.oRow.IsGroup=Object(h.j)(this.dv[this.k].IsGroup),this.oRow.Cells[1].level=this.oRow.LevelNo,this.UpdateTreeTotals(this.oRow.LevelNo),Object(h.j)(this.dv[this.k].IsGroup))){this.lstParents.push(this.oRow),this.lstTotal.push(new Array(this.oColumns.length).fill(0)),this.oRow.Type=n.f.BalanceBF;for(let t=0;t<this.oRow.Cells.length;t++)this.oRow.Cells[t].IsNormal=!1,this.oRow.Cells[t].CellAppearance=this.oColumns[t].DataAppearance.Clone(),this.oRow.Cells[t].CellAppearance.ForeColor=this.BalanceBFAppearance.ForeColor}if(this.oRow.IsGroup||!(parseFloat(this.dv[this.k].BalQty)<0)){this.oRow.NodeID=parseInt(this.dv[this.k].ProductID);for(let e=0;e<this.oColumns.length;e++)this.CellValue=null,Object(u.isUndefined)(this.dv[this.k][this.oColumns[e].ID])||(this.CellValue=this.dv[this.k][this.oColumns[e].ID]),null!=this.CellValue&&(this.ViewModel.SetCellValue(this.CellValue,this.oColumns[e].DataFormat,this.oColumns[e].ColumnType,this.oRow.Cells[e]),o.e.IsNum(this.CellValue)&&(t=o.e.Double(this.CellValue),this.lstTotal.length>0&&(this.lstTotal[this.lstTotal.length-1][e]+=t),this.ViewModel.totals[e][this.ViewModel.lstGroup.length]+=t));this.oRow.LevelNo<=this.LevelNo&&(this.oRow.IsGroup||this.ViewModel.ApplyKPI(this.oRow),this.GrdRow++,this.ViewModel.addRow(this.oRow))}}this.ShowLevelTree&&this.UpdateTreeTotals(0),this.ViewModel.CheckAndAddTotals(this.dv)}addProductWiseExpiryAgeing(){let t;for(this.lstParents.Clear(),this.lstTotal.Clear(),this.lstParents.push(this.NewReportRow()),this.lstTotal.push(new Array(this.oColumns.length).fill(0)),this.k=0;this.k<this.dv.length;this.k++){if(this.ViewModel.process.CancellationPending)return void(this.ViewModel.processArgs.Cancel=!0);if(this.oRow=this.NewReportRow(),this.oRow.Height=this.ViewModel.RowHeight,this.ShowLevelTree&&(this.oRow.LevelNo=parseInt(this.dv[this.k].Depth)-1,this.oRow.Cells[1].IsNormal=!1,this.oRow.IsGroup=Object(h.j)(this.dv[this.k].IsGroup),this.oRow.Cells[1].level=this.oRow.LevelNo,this.UpdateTreeTotals(this.oRow.LevelNo),Object(h.j)(this.dv[this.k].IsGroup))){this.lstParents.push(this.oRow),this.lstTotal.push(new Array(this.oColumns.length).fill(0)),this.oRow.Type=n.f.BalanceBF;for(let t=0;t<this.oRow.Cells.length;t++)this.oRow.Cells[t].IsNormal=!1,this.oRow.Cells[t].CellAppearance=this.oColumns[t].DataAppearance.Clone(),this.oRow.Cells[t].CellAppearance.ForeColor=this.BalanceBFAppearance.ForeColor}this.oRow.NodeID=parseInt(this.dv[this.k].ProductID);for(let e=0;e<this.oColumns.length;e++)this.CellValue=null,Object(u.isUndefined)(this.dv[this.k][this.oColumns[e].ID])||(this.CellValue=this.dv[this.k][this.oColumns[e].ID]),null!=this.CellValue&&(this.ViewModel.SetCellValue(this.CellValue,this.oColumns[e].DataFormat,this.oColumns[e].ColumnType,this.oRow.Cells[e]),o.e.IsNum(this.CellValue)&&(t=o.e.Double(this.CellValue),this.lstTotal.length>0&&(this.lstTotal[this.lstTotal.length-1][e]+=t)));this.oRow.LevelNo<=this.LevelNo&&(this.oRow.IsGroup||this.ViewModel.ApplyKPI(this.oRow),this.GrdRow++,this.ViewModel.addRow(this.oRow))}if(null!=this.SlabPercent&&(this.dblQty=0,this.ViewModel.GrpReportTotal.TotalCols.ContainsKey("Quantity")&&(this.dblQty=this.lstTotal[0][this.ViewModel.GrpReportTotal.TotalCols.Quantity]),this.ViewModel.GrpReportTotal.TotalCols.ContainsKey("Expired")&&(this.dblQty=this.dblQty-this.lstTotal[0][this.ViewModel.GrpReportTotal.TotalCols.Expired]),0!=this.dblQty))for(let e=0;e<=this.Slabs.length;e++)this.ViewModel.GrpReportTotal.TotalCols.ContainsKey("S"+e)&&(t=this.lstTotal[0][this.ViewModel.GrpReportTotal.TotalCols["S"+e]],t=100*t/this.dblQty,this.lstTotal[0][this.ViewModel.GrpReportTotal.TotalCols["S"+e]+1]=t);this.AddReportTotals()}UpdateTreeTotals(t){for(let e=this.lstTotal.length-1;e>t;e--){if(e>0)for(let t=0;t<this.lstTotal[e].length;t++)this.lstTotal[e-1][t]+=this.lstTotal[e][t];for(let t=0;t<this.oColumns.length;t++)"FLOAT"==this.oColumns[t].ColumnType&&this.ViewModel.SetCellValue(this.lstTotal[e][t],this.oColumns[t].DataFormat,"FLOAT",this.lstParents[e].Cells[t]);if(t<=this.LevelNo){let t=this.ViewModel.Data.indexOf(this.lstParents[e]);t>=0&&(this.ViewModel.Data.Remove(this.lstParents[e]),this.ViewModel.Data.Insert(t,this.lstParents[e]))}this.lstParents.RemoveAt(e),this.lstTotal.RemoveAt(e)}}AddProductWiseBatchWiseAgeing(){let t,e,s;for(this.k=0;this.k<this.dv.length;this.k++){this.oRow=this.NewReportRow(),this.oRow.LevelNo=this.ViewModel.lstGroup.length,this.ViewModel.AddGroupRows(this.dv,this.k),this.dv[this.k].Expired=null;for(let t=0;t<=this.Slabs.length;t++)this.dv[this.k]["S"+t]=null;if(null==this.dv[this.k].ExpDate&&(this.dv[this.k].ExpDate=this.ViewModel.oReportDialog.ToDate.Date),s=new Date(this.dv[this.k].ExpDate),s<this.ViewModel.oReportDialog.ToDate.Date)this.dv[this.k].Expired=this.dv[this.k].Quantity;else{for(t=0;t<this.Slabs.length&&!(s<this.Slabs[t]);t++);t>=0?this.dv[this.k]["S"+t]=this.dv[this.k].Quantity:this.dv[this.k].S0=this.dv[this.k].Quantity}for(let t=0;t<this.oColumns.length;t++)this.CellValue=null,Object(u.isUndefined)(this.dv[this.k][this.oColumns[t].ID])||(this.CellValue=this.dv[this.k][this.oColumns[t].ID]),null!=this.CellValue&&(this.ViewModel.SetCellValue(this.CellValue,this.oColumns[t].DataFormat,this.oColumns[t].ColumnType,this.oRow.Cells[t]),o.e.IsNum(this.CellValue)&&(e=o.e.Double(this.CellValue),this.ViewModel.totals[t][this.ViewModel.lstGroup.length]+=e));this.ViewModel.ApplyKPI(this.oRow),this.ViewModel.addRow(this.oRow)}this.ViewModel.CheckAndAddTotals(this.dv)}AddProductWiseSubstitues(t){let e=0;if(null==this.dtProducts){let t,e=this.dsMain.Tables[1];this.dtProducts=this.dv.ToTable(!0,["ProductID"]),this.dtProducts.forEach(s=>{this.dv=this.dvTable.filter(t=>t.SProductID==s.ProductID),this.dv.length>0&&(s.QOH=this.dv[0].QOH,e=this.dsMain.Tables[1].filter(t=>t.ProductID==s.ProductID),e.length>0?(t="",e.forEach(e=>{t.length>0&&(t+=", "),t+=e.SubstituteGroupName.toString()}),s.Product=this.dv[0].SName.toString()+" ("+t+")"):s.Product=this.dv[0].SName)})}let s=this.dtProducts.Copy();s.SortBy(["Product"]),this.dv.SortBy(["SName"]),o.e.IsEmpty(t)||(t=" and "+t);for(let i=0;i<s.length;i++){if(this.ViewModel.process.CancellationPending)return void(this.ViewModel.processArgs.Cancel=!0);for(this.oRow=this.NewReportRow_2(n.f.Group,this.ViewModel.lstGroup[0].GroupAppearance),this.ViewModel.lstGroup[0].Height>0&&(this.oRow.Height=this.ViewModel.lstGroup[0].Height),this.oRow.Cells[0].Text=s[i].Product.toString(),-1!=this.colQOHIndex?(this.oRow.Cells[0].ColSpan=this.colQOHIndex,this.ViewModel.SetCellValue(s[i].QOH.toString(),this.oColumns[this.colQOHIndex].DataFormat,this.oColumns[this.colQOHIndex].ColumnType,this.oRow.Cells[this.colQOHIndex]),this.oRow.Cells[this.colQOHIndex].CellAppearance.Alignment="Right"):this.oRow.Cells[0].ColSpan=this.dv.length,this.ViewModel.addRow(this.oRow),e=parseInt(s[i].ProductID),this.dv=this.dvTable.filter(t=>t.ProductID==e),this.k=0;this.k<this.dv.length;this.k++)if(parseInt(this.dv[this.k].SProductID)!=e){this.oRow=this.NewReportRow();for(let t=0;t<this.oColumns.length;t++)this.CellValue=null,Object(u.isUndefined)(this.dv[this.k][this.oColumns[t].ID])||(this.CellValue=this.dv[this.k][this.oColumns[t].ID]),null!=this.CellValue&&this.ViewModel.SetCellValue(this.CellValue,this.oColumns[t].DataFormat,this.oColumns[t].ColumnType,this.oRow.Cells[t]);this.ViewModel.ApplyKPI(this.oRow),this.ViewModel.addRow(this.oRow)}}}}}}]);